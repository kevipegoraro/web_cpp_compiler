<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>nanLanguage Web</title>

<!-- CodeMirror -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/codemirror.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/theme/dracula.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/codemirror.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/mode/clike/clike.min.js"></script>

<style>
*,
*::before,
*::after {
  box-sizing: border-box;
}

:root{
  --bg:#ffffff;
  --text:#111111;
  --muted:#444;
  --panel:#111111;
  --panelText:#eeeeee;
  --border:#cccccc;
  --btnBg:#f2f2f2;
  --btnText:#111;
}
body.dark{
  --bg:#0f1115;
  --text:#e6e6e6;
  --muted:#b8b8b8;
  --panel:#0b0c0f;
  --panelText:#e6e6e6;
  --border:#2a2f3a;
  --btnBg:#1b1f2a;
  --btnText:#e6e6e6;
}

/* --- Base Layout --- */

body{
  font-family: Arial, sans-serif;
  margin:0;
  padding:24px 16px;
  background: var(--bg);
  color: var(--text);
  height:100vh;
  box-sizing:border-box;
  display:flex;
  flex-direction:column;
}

h1{ margin:0 0 10px; }
.hint{ font-size:13px; color:var(--muted); margin-bottom:10px; }

.row{
  display:flex;
  gap:10px;
  align-items:center;
  flex-wrap:wrap;
  margin:10px 0;
}

button{
  padding:8px 14px;
  cursor:pointer;
  border:1px solid var(--border);
  border-radius:10px;
  background:var(--btnBg);
  color:var(--btnText);
}

input{
  padding:8px 10px;
  border:1px solid var(--border);
  border-radius:10px;
  background:transparent;
  color:var(--text);
  min-width:240px;
}

.status{ font-size:14px; color:var(--muted); }

/* --- Main Layout Container --- */

#mainLayout{
  margin-top:16px;
  flex:1;
  display:flex;
  min-height:0;   /* CRITICAL */
}

/* --- Blocks --- */

.block{
  min-height:0;   /* CRITICAL for flex shrink */
}

/* --- Vertical (stacked) --- */

.layout-vertical{
  flex-direction:column;
  gap:16px;
}

.layout-vertical .block{
  flex:1;
  display:flex;
  flex-direction:column;
}

/* --- Horizontal (33% each) --- */

.layout-horizontal{
  flex-direction:row;
  gap:16px;
}

.layout-horizontal .block{
  flex:1 1 33%;
  min-width:0;
  display:flex;
  flex-direction:column;
}

/* --- Panels --- */

.panel{
  display:flex;
  flex-direction:column;
}

/* --- Editor --- */

#editorBlock{
  display:flex;
  flex-direction:column;
  min-height:0;
}

.CodeMirror{
  flex:1;
  min-height:0;
  border:1px solid var(--border);
  border-radius:10px;
  font-size:14px;
}

/* --- Input & Output --- */

textarea{
  width:100%;
  border-radius:10px;
  padding:8px;
  border:1px solid var(--border);
  background:transparent;
  color:var(--text);
  flex:1;
  min-height:0;
}

pre{
  background:var(--panel);
  color:var(--panelText);
  padding:12px;
  border-radius:10px;
  overflow:auto;
  border:1px solid var(--border);
  white-space:pre-wrap;
  flex:1;
  min-height:0;
}
</style>


</head>

<body>

<h1>Web nanLanguage C++ Code-Editor</h1>
<div class="hint">
Runs locally. Programs have ~2s runtime limit.
</div>

<div class="row">
  <button id="themeBtn">Dark mode</button>
  <button id="layoutBtn">Side-by-side</button>

  <input id="fileName" value="start_code.cpp" />
  <button id="loadBtn">Load</button>
  <button id="saveBtn">Save</button>
  <button id="runBtn">Run</button>
  <button id="runNanBtn">Run nanLanguage Script</button>


  <span class="status" id="status">Ready.</span>
</div>

<div id="mainLayout" class="layout-vertical">
  <div class="block" id="editorBlock">
    <h3>nanLanguage C++ Interpreter</h3>
<textarea id="code">
#include <iostream>
using namespace std;

int main() {
    cout << "Hello World!" << endl;
    return 0;
}
</textarea>
  </div>

  <div class="block panel">
    <h3>nanLanguage Program</h3>
    <textarea id="inputBox">comment "Print needs qouetes"
comment "Add functions"
comment "Add api to AI"
commant "write to files/open files"
print "Hello World"
set x = 10
print x
add x 5
comment "We can do comments now!!"
add x 50
add x 5000
print "After adding:"
print x
print "Start Loop"
comment "Loops are form 0 to one before the specified value"
loop i:15 (
comment "Add one to print from 1 to 15
set aux = i
add aux 1
print aux
)
print "Done"

print "Nested loops"
loop i:3 (
    loop j:2 (
        print i
        print j
    )
)



print "Ifs"
set x = 5

if x > 3 (
    print "greater"
)

if x == 5 (
    print "equal"
)



print "New operations"
set x = 10

add x 5      
sub x 3      
mult x 2     
div x 4      

print x</textarea>
  </div>

  <div class="block panel">
    <h3>Output</h3>
    <pre id="output">(nothing yet)</pre>
  </div>

</div>

<script>
const statusEl = document.getElementById("status");
const outputEl = document.getElementById("output");
const runBtn = document.getElementById("runBtn");
const runNanBtn = document.getElementById("runNanBtn");
const saveBtn = document.getElementById("saveBtn");
const loadBtn = document.getElementById("loadBtn");
const themeBtn = document.getElementById("themeBtn");
const layoutBtn = document.getElementById("layoutBtn");
const fileNameEl = document.getElementById("fileName");
const mainLayout = document.getElementById("mainLayout");

function setStatus(msg){ statusEl.textContent = msg; }
function setOutput(msg){ outputEl.textContent = msg; }

/* CodeMirror */
const editor = CodeMirror.fromTextArea(
  document.getElementById("code"),
  {
    mode:"text/x-c++src",
    lineNumbers:true,
    indentUnit:4,
    tabSize:4,
    lineWrapping:true
  }
);

/* Theme */
function applyTheme(isDark){
  document.body.classList.toggle("dark", isDark);
  editor.setOption("theme", isDark ? "dracula" : "default");
  themeBtn.textContent = isDark ? "Light mode" : "Dark mode";
  localStorage.setItem("editor_theme", isDark ? "dark" : "light");
}

const savedTheme = localStorage.getItem("editor_theme");
applyTheme(savedTheme === "dark");

themeBtn.addEventListener("click", () => {
  applyTheme(!document.body.classList.contains("dark"));
});

/* Layout */
function setLayout(horizontal){
  mainLayout.classList.toggle("layout-horizontal", horizontal);
  mainLayout.classList.toggle("layout-vertical", !horizontal);
  layoutBtn.textContent = horizontal ? "Stacked" : "Side-by-side";
  localStorage.setItem("editor_layout", horizontal ? "horizontal" : "vertical");
  setTimeout(()=>editor.refresh(),50);
}

const savedLayout = localStorage.getItem("editor_layout");
setLayout(savedLayout === "horizontal");

layoutBtn.addEventListener("click", () => {
  const isHorizontal = mainLayout.classList.contains("layout-horizontal");
  setLayout(!isHorizontal);
});

/* Backend calls */
function safeName(){
  const name = (fileNameEl.value || "start_code.cpp").trim();
  return name.length ? name : "start_code.cpp";
}

async function loadFile(){
  const name = safeName();
  setStatus("Loading...");
  try{
    const res = await fetch("/load?name="+encodeURIComponent(name));
    const text = await res.text();
    if(!res.ok){
      setOutput("Load failed:\n"+text);
      return;
    }
    editor.setValue(text);
    setStatus("Loaded.");
  }catch(e){
    setOutput("Load request failed: "+e);
  }
}

async function saveFile(){
  const name = safeName();
  setStatus("Saving...");
  try{
    const res = await fetch("/save?name="+encodeURIComponent(name),{
      method:"POST",
      headers:{ "Content-Type":"text/plain; charset=utf-8" },
      body:editor.getValue()
    });
    const data = await res.json();
    if(!res.ok || !data.ok){
      setOutput("Save failed:\n"+(data.error||"Unknown error"));
      return;
    }
    setStatus("Saved.");
  }catch(e){
    setOutput("Save request failed: "+e);
  }
}

async function runCode(){
  runBtn.disabled = true;
  setStatus("Running...");
  try{
    const res = await fetch("/run",{
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body:JSON.stringify({
        code:editor.getValue(),
        input:document.getElementById("inputBox").value
      })
    });
    const data = await res.json();
    if(!data.ok){
      setOutput("Error:\n"+(data.error||data.output||"Unknown error"));
    }else{
      let out="";
      out+="exit_code: "+data.exit_code+"\n";
      if(data.timed_out) out+="Timed out\n";
      out+="\nOutput:\n"+(data.output||"");
      setOutput(out);
      setStatus("Done.");
    }
  }catch(e){
    setOutput("Request failed: "+e);
  }finally{
    runBtn.disabled = false;
  }
}

async function runNanProgram(){
  runNanBtn.disabled = true;
  setStatus("Running nanLanguage script...");

  try{
    const res = await fetch("/run-nan",{
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body:JSON.stringify({
        program: document.getElementById("inputBox").value
      })
    });

    const data = await res.json();

    if(!data.ok){
      setOutput("Error:\n"+(data.error || "Unknown error"));
    }else{
      let out="";
      out += "exit_code: " + data.exit_code + "\n";
      if(data.timed_out) out += "Timed out\n";
      out += "\nOutput:\n" + (data.output || "");
      setOutput(out);
      setStatus("Done.");
    }

  }catch(e){
    setOutput("Request failed: " + e);
  }finally{
    runNanBtn.disabled = false;
  }
}

runNanBtn.addEventListener("click", runNanProgram);


loadBtn.addEventListener("click", loadFile);
saveBtn.addEventListener("click", saveFile);
runBtn.addEventListener("click", runCode);

/* Initial load */
loadFile();
</script>

</body>
</html>
